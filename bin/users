#!/usr/bin/env node

/* eslint no-console: 0 */

const program = require('commander');
const mongoose = require('mongoose');
const chalk = require('chalk');
const promptly = require('promptly');
const User = require('../app/models/user');

function done(err, user) {
  if (err) throw err;
  console.log(chalk.green(`Created user ${user.username}`));
  process.exit(0);
}

function validator(value) {
  if (typeof parseInt(value) !== 'number') {
    throw new Error('-------------\nNot a number!\n-------------');
  }
  if (![1, 2, 3].includes(parseInt(value))) {
    throw new Error('---------------\nMode out of range!\n---------------');
  }
  return value;
}

const options = {
  useCreateIndex: true,
  useUnifiedTopology: true,
  useNewUrlParser: true,
};

program
  .version('1.0.0')
  .command('create-user <username> <cardKey>')
  .description('create a new user')
  .action((username, cardKey) => {
    const mongoURL = process.env.MONGO_URL || 'mongodb://localhost:27017/vote';

    promptly.prompt(
      'Usermode: \n [1] for User \n [2] for Moderator \n [3] for Admin \n Enter mode: ',
      { validator, retry: true },
      (modeErr, mode) => {
        mongoose.connect(mongoURL, options, (connectErr) => {
          if (connectErr) return done(connectErr);

          promptly.password('Enter password: ', async (pwErr, password) => {
            if (pwErr) return done(pwErr);
            const user = new User({
              username: username,
              admin: mode == 3,
              moderator: mode == 2 || mode == 3,
              cardKey: cardKey,
            });

            const registeredUser = await User.register(user, password);
            done(registeredUser);
          });
        });
      }
    );
  });

program
  .version('1.0.0')
  .command('create-fixtures')
  .description('creates test users')
  .action(() => {
    if (process.env.NODE_ENV === 'production') {
      throw 'Cannot create fixtures in production';
    }
    const mongoURL = process.env.MONGO_URL || 'mongodb://localhost:27017/vote';

    // prettier-ignore
    const fixtures = [ { username: "admin", admin: true, moderator: true, cardKey: "12340", password: "password" }, { username: "moderator1", admin: false, moderator: true, cardKey: "12341", password: "password" }, { username: "moderator2", admin: false, moderator: true, cardKey: "12342", password: "password" }, { username: "user1", admin: false, moderator: false, cardKey: "12343", password: "password" }, { username: "user2", admin: false, moderator: false, cardKey: "12344", password: "password" }, { username: "user3", admin: false, moderator: false, cardKey: "12345", password: "password" }, { username: "user4", admin: false, moderator: false, cardKey: "12346", password: "password" }, { username: "user5", admin: false, moderator: false, cardKey: "12347", password: "password" }, ]
    
    mongoose.connect(mongoURL, options, connectErr => {
      if (connectErr) return done(connectErr);
      fixtures.forEach(f => {
        const user = new User({...f});
        User.register(user, f.password).nodeify(done);
        })
      });
  });

program.parse(process.argv);
